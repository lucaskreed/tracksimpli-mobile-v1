<!-- Camera test screen -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TrackSimpli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <style>
    :root{
      --bg:#000;
      --panel: rgba(0,0,0,.72);
      --panel2: rgba(0,0,0,.88);
      --text:#fff;
      --muted: rgba(255,255,255,.72);
      --brand:#2a3cff;
      --good:#28d17c;
      --warn:#ffcc00;
      --bad:#ff3b30;
      --card:#0b0d10;
      --border: rgba(255,255,255,.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow:hidden;
    }
    #video, #overlay{
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      object-fit:cover;
    }
    #overlay{ pointer-events:none; }

    /* Top bar */
    #topbar{
      position:fixed; top:0; left:0; width:100%;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(rgba(0,0,0,.80), rgba(0,0,0,.10));
      gap:10px;
    }
    #logo{
      font-weight:800; letter-spacing:.3px; font-size:16px;
      padding:10px 12px; border-radius:14px; background:rgba(0,0,0,.35);
      border:1px solid var(--border);
      display:flex; align-items:center; gap:8px;
    }
    #badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.10); border:1px solid var(--border);
      color:var(--muted);
      max-width:54vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    #menuBtn{
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.35);
      color:#fff; font-weight:700;
    }

    /* HUD bottom */
    #hud{
      position:fixed; bottom:0; left:0; width:100%;
      padding:18px 14px 18px 14px;
      background:linear-gradient(transparent, rgba(0,0,0,.90));
    }
    #bigRow{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:14px;
    }
    #reps{
      font-size:72px; font-weight:900; line-height:0.95;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }
    #subStats{
      display:flex; flex-direction:column; align-items:flex-end;
      gap:6px; min-width:160px;
    }
    .chip{
      font-size:12px; color:var(--muted);
      padding:8px 10px; border-radius:999px;
      background:rgba(0,0,0,.40);
      border:1px solid var(--border);
      width:fit-content;
      max-width:55vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    #controls{
      display:flex; gap:10px; margin-top:12px;
    }
    button{
      border:none; border-radius:16px;
      padding:16px 14px;
      font-size:16px; font-weight:800;
      color:#fff; background:var(--brand);
      flex:1;
    }
    button.secondary{
      background:rgba(255,255,255,.12);
      border:1px solid var(--border);
      color:#fff;
      font-weight:800;
    }
    button.danger{
      background:rgba(255,59,48,.85);
    }
    button:active{ transform:scale(.99); }

    /* Drawer */
    #drawer{
      position:fixed; top:0; right:-420px; height:100%; width:min(420px, 92vw);
      background:var(--panel2);
      border-left:1px solid var(--border);
      padding:14px;
      transition:right .25s ease;
      overflow:auto;
      backdrop-filter: blur(10px);
      z-index:20;
    }
    #drawer.open{ right:0; }
    #drawer h2{ margin:8px 0 10px 0; font-size:18px; }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      margin:10px 0;
    }
    .row{ display:flex; justify-content:space-between; gap:10px; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ font-size:14px; font-weight:800; }
    .smallBtn{
      width:100%;
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.10);
      border:1px solid var(--border);
      font-weight:800;
    }
    .tiny{ font-size:12px; color:var(--muted); line-height:1.35; }

    /* Modal */
    #modalWrap{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:30;
      padding:16px;
    }
    #modalWrap.show{ display:flex; }
    #modal{
      width:min(520px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:14px;
    }
    #modal h3{ margin:6px 0 10px; }
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-size:14px;
      outline:none;
    }
    #modalBtns{ display:flex; gap:10px; margin-top:12px; }
    #shareCanvas{ display:none; } /* used for share image */

    /* Challenge banner */
    #challenge{
      position:fixed; left:12px; right:12px; top:62px;
      background:rgba(42,60,255,.20);
      border:1px solid rgba(42,60,255,.45);
      padding:10px 12px; border-radius:16px;
      display:none; z-index:15;
      backdrop-filter: blur(10px);
    }
    #challenge b{ font-weight:900; }
  </style>
</head>

<body>
  <video id="video" playsinline></video>
  <canvas id="overlay"></canvas>

  <div id="topbar">
    <div id="logo">TrackSimpli <span style="opacity:.6;font-weight:900;">•</span> <span style="opacity:.8">Pushups</span></div>
    <div id="badge">Ready</div>
    <button id="menuBtn" onclick="toggleDrawer()">Stats</button>
  </div>

  <div id="challenge"></div>

  <div id="hud">
    <div id="bigRow">
      <div id="reps">0</div>
      <div id="subStats">
        <div class="chip" id="chipTime">00:00</div>
        <div class="chip" id="chipQuality">Quality: —</div>
        <div class="chip" id="chipStreak">Streak: —</div>
      </div>
    </div>

    <div id="controls">
      <button id="btnMain" onclick="mainAction()">START</button>
      <button class="secondary" id="btnPause" onclick="togglePause()" disabled>PAUSE</button>
      <button class="danger" id="btnEnd" onclick="endWorkout()" disabled>END</button>
    </div>
  </div>

  <div id="drawer">
    <h2>Dashboard</h2>

    <div class="card">
      <div class="row"><div class="k">Today</div><div class="v" id="dToday">—</div></div>
      <div class="row" style="margin-top:8px;"><div class="k">Personal Best (reps)</div><div class="v" id="dPB">—</div></div>
      <div class="row" style="margin-top:8px;"><div class="k">Streak</div><div class="v" id="dStreak">—</div></div>
      <button class="smallBtn" onclick="openHistory()">View History</button>
    </div>

    <div class="card">
      <div class="k">Last session</div>
      <div class="v" id="dLast">—</div>
      <div class="tiny" id="dLastDetail" style="margin-top:6px;">No history yet.</div>
      <button class="smallBtn" onclick="shareLast()" id="btnShareLast" disabled>Share last result</button>
      <button class="smallBtn" onclick="copyChallengeLink()" id="btnChallenge" disabled>Copy challenge link</button>
    </div>

    <div class="card">
      <div class="k">Quality breakdown</div>
      <div class="tiny" id="dQuality">Depth, tempo, and body line. No half-rep heroics.</div>
    </div>

    <div class="card">
      <div class="k">Tools</div>
      <button class="smallBtn" onclick="clearData()">Reset local data</button>
      <div class="tiny" style="margin-top:8px;">
        Note: history is stored on this device only (no login yet).
      </div>
    </div>
  </div>

  <!-- Modal for history -->
  <div id="modalWrap">
    <div id="modal">
      <h3 id="modalTitle">History</h3>
      <div id="modalBody" class="tiny"></div>
      <div id="modalBtns">
        <button class="secondary" onclick="closeModal()">Close</button>
        <button onclick="exportJSON()">Export JSON</button>
      </div>
    </div>
  </div>

  <canvas id="shareCanvas"></canvas>

<script>
/* ---------------------------
   Storage helpers
---------------------------- */
const STORE_KEY = "tracksimpli_history_v1";
const PB_KEY = "tracksimpli_pb_v1";
const STREAK_KEY = "tracksimpli_streak_v1";

function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function todayStr(){
  const d = new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/* ---------------------------
   UI elements
---------------------------- */
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const badge = document.getElementById("badge");

const repsEl = document.getElementById("reps");
const chipTime = document.getElementById("chipTime");
const chipQuality = document.getElementById("chipQuality");
const chipStreak = document.getElementById("chipStreak");

const btnMain = document.getElementById("btnMain");
const btnPause = document.getElementById("btnPause");
const btnEnd = document.getElementById("btnEnd");

const drawer = document.getElementById("drawer");
const modalWrap = document.getElementById("modalWrap");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");

const dToday = document.getElementById("dToday");
const dPB = document.getElementById("dPB");
const dStreak = document.getElementById("dStreak");
const dLast = document.getElementById("dLast");
const dLastDetail = document.getElementById("dLastDetail");
const dQuality = document.getElementById("dQuality");
const btnShareLast = document.getElementById("btnShareLast");
const btnChallenge = document.getElementById("btnChallenge");
const challengeBanner = document.getElementById("challenge");

/* ---------------------------
   Pose + workout state
---------------------------- */
let detector = null;
let running = false;
let paused = false;

let reps = 0;
let down = false;
let lastPhase = Date.now();

let startTs = 0;
let pauseAccumMs = 0;
let pauseStart = 0;

let minElbow = 180;
let alignSamples = [];   // abs(hipY - shoulderY)
let repTimes = [];       // ms per rep (up transition time)
let lastRepTs = 0;

let stream = null;

function mmss(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const m = Math.floor(s/60);
  const r = s%60;
  return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
}

function angle(a,b,c){
  const ab=[a.x-b.x,a.y-b.y], cb=[c.x-b.x,c.y-b.y];
  const dot=ab[0]*cb[0]+ab[1]*cb[1];
  const mag=Math.hypot(...ab)*Math.hypot(...cb);
  return mag ? Math.acos(dot/mag)*180/Math.PI : 180;
}

/* ---------------------------
   Quality scoring
   (simple, stable, explainable)
---------------------------- */
function computeQuality(){
  // Depth score: reward lower minElbow (deeper)
  // target min <= 80 is great, >=120 is bad
  const depth = clamp(mapRange(minElbow, 120, 80, 0, 100), 0, 100);

  // Tempo score: reps not too fast and consistent
  // ideal rep time ~ 1.2s–2.8s, penalize <0.8s bounce
  let tempo = 0;
  if(repTimes.length >= 2){
    const avg = average(repTimes)/1000;
    const stdev = stddev(repTimes)/1000;

    const speedScore = clamp(mapRange(avg, 0.8, 2.2, 20, 100), 0, 100);
    const consistencyScore = clamp(mapRange(stdev, 0.9, 0.15, 30, 100), 0, 100);
    tempo = Math.round(0.6*speedScore + 0.4*consistencyScore);
  } else {
    tempo = 50; // not enough info
  }

  // Alignment score: smaller shoulder-hip vertical delta = straighter body line.
  // On many phones coords are px-ish. Use sample average.
  let align = 0;
  if(alignSamples.length){
    const a = average(alignSamples);
    // <90 px very straight, >160 px sloppy
    align = clamp(mapRange(a, 160, 90, 30, 100), 0, 100);
  } else {
    align = 60;
  }

  const total = Math.round(0.45*depth + 0.30*tempo + 0.25*align);
  return { total, depth: Math.round(depth), tempo, align: Math.round(align) };
}

function clamp(x,a,b){ return Math.min(b, Math.max(a, x)); }
function mapRange(x,inMin,inMax,outMin,outMax){
  // linear mapping where inMax < inMin is fine
  const t = (x - inMin) / (inMax - inMin);
  return outMin + t*(outMax - outMin);
}
function average(arr){ return arr.reduce((s,v)=>s+v,0)/arr.length; }
function stddev(arr){
  const avg = average(arr);
  const v = average(arr.map(x => (x-avg)*(x-avg)));
  return Math.sqrt(v);
}

/* ---------------------------
   Controls
---------------------------- */
function toggleDrawer(){
  drawer.classList.toggle("open");
}
function setBadge(text){ badge.textContent = text; }

async function initDetector(){
  if(detector) return;
  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
  );
}

async function startWorkout(){
  // Camera must be triggered by user gesture (button click).
  await initDetector();

  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
  video.srcObject = stream;
  await video.play();

  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;

  // reset session stats
  running = true;
  paused = false;

  reps = 0;
  down = false;
  lastPhase = Date.now();
  startTs = Date.now();
  pauseAccumMs = 0;
  pauseStart = 0;

  minElbow = 180;
  alignSamples = [];
  repTimes = [];
  lastRepTs = 0;

  repsEl.textContent = "0";
  btnMain.textContent = "RUNNING";
  btnMain.disabled = true;
  btnPause.disabled = false;
  btnEnd.disabled = false;
  btnPause.textContent = "PAUSE";

  setBadge("Camera on • tracking");
  loop();
}

function togglePause(){
  if(!running) return;
  paused = !paused;

  if(paused){
    pauseStart = Date.now();
    btnPause.textContent = "RESUME";
    setBadge("Paused");
  } else {
    pauseAccumMs += (Date.now() - pauseStart);
    pauseStart = 0;
    btnPause.textContent = "PAUSE";
    setBadge("Camera on • tracking");
    loop();
  }
}

function endWorkout(){
  if(!running) return;
  running = false;
  paused = false;

  // stop camera
  try{
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  }catch{}

  ctx.clearRect(0,0,overlay.width, overlay.height);

  const elapsedMs = (Date.now() - startTs) - pauseAccumMs;
  const q = computeQuality();

  btnMain.disabled = false;
  btnMain.textContent = "START";
  btnPause.disabled = true;
  btnEnd.disabled = true;

  setBadge("Ended • saved locally");
  chipQuality.textContent = `Quality: ${q.total}`;
  openSaveModal({ elapsedMs, q });
}

function mainAction(){
  if(!running) startWorkout();
}

function updateTimeChip(){
  if(!running) return;
  const now = Date.now();
  const elapsedMs = (paused ? (pauseStart - startTs - pauseAccumMs) : (now - startTs - pauseAccumMs));
  chipTime.textContent = mmss(elapsedMs);
  requestAnimationFrame(updateTimeChip);
}

/* ---------------------------
   Rep counting loop
---------------------------- */
async function loop(){
  if(!running || paused) return;

  const poses = await detector.estimatePoses(video);
  ctx.clearRect(0,0,overlay.width, overlay.height);

  if(poses[0]){
    const lm = poses[0].keypoints;

    // MoveNet keypoint indexes:
    // 5 leftShoulder, 7 leftElbow, 9 leftWrist, 11 leftHip
    const s = lm[5], e = lm[7], w = lm[9], h = lm[11];

    if(s?.score > 0.25 && e?.score > 0.25 && w?.score > 0.25 && h?.score > 0.25){
      const a = angle(s,e,w);
      minElbow = Math.min(minElbow, a);

      const align = Math.abs(h.y - s.y);
      alignSamples.push(align);
      if(alignSamples.length > 180) alignSamples.shift(); // keep last ~few seconds

      const now = Date.now();

      // Anti-cheat gating:
      // down when elbow < 85 and held at least 500ms
      if(a < 85 && !down && now - lastPhase > 500){
        down = true;
        lastPhase = now;
      }

      // rep counts only when elbow returns >165 with min tempo and body line not collapsing
      if(a > 165 && down && now - lastPhase > 400 && align < 120){
        reps++;
        down = false;
        lastPhase = now;

        if(lastRepTs){
          repTimes.push(now - lastRepTs);
          if(repTimes.length > 50) repTimes.shift();
        }
        lastRepTs = now;

        repsEl.textContent = String(reps);

        const q = computeQuality();
        chipQuality.textContent = `Quality: ${q.total}`;
      }

      // draw joints (simple + fast)
      drawDot(s, "#00ff00");
      drawDot(e, "#00ff00");
      drawDot(w, "#00ff00");
      drawDot(h, "#00ff00");
      drawLine(s,e, "rgba(0,255,0,.8)");
      drawLine(e,w, "rgba(0,255,0,.8)");
      drawLine(s,h, "rgba(0,255,0,.6)");
    }
  }

  requestAnimationFrame(loop);
}

function drawDot(p,color){
  ctx.beginPath();
  ctx.arc(p.x, p.y, 7, 0, Math.PI*2);
  ctx.fillStyle = color;
  ctx.fill();
}
function drawLine(a,b,color){
  ctx.beginPath();
  ctx.moveTo(a.x,a.y);
  ctx.lineTo(b.x,b.y);
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.stroke();
}

/* ---------------------------
   Save + history + PB + streak
---------------------------- */
function openSaveModal({ elapsedMs, q }){
  modalTitle.textContent = "Save workout";
  const date = todayStr();

  modalBody.innerHTML = `
    <div style="margin-bottom:10px;">
      <div><span class="k">Reps</span> <span class="v">${reps}</span></div>
      <div><span class="k">Time</span> <span class="v">${mmss(elapsedMs)}</span></div>
      <div><span class="k">Quality</span> <span class="v">${q.total}</span></div>
    </div>
    <div class="k" style="margin-top:10px;">Label (optional)</div>
    <input id="labelInput" placeholder="e.g., morning set, post-run, etc." />
    <div class="tiny" style="margin-top:10px;">
      Saved locally on this device. No account needed.
    </div>
  `;

  // replace modal buttons with Save/Share/Close for this modal
  const btns = document.getElementById("modalBtns");
  btns.innerHTML = `
    <button class="secondary" onclick="closeModal()">Close</button>
    <button onclick="saveWorkout()">Save</button>
    <button onclick="shareCard()">Share</button>
  `;

  modalWrap.classList.add("show");

  // update streak/PB preview
  const streak = computeStreakPreview(date);
  chipStreak.textContent = `Streak: ${streak}d`;
}

function computeStreakPreview(date){
  const streak = loadJSON(STREAK_KEY, { lastDate: null, count: 0 });
  if(!streak.lastDate) return 1;
  if(streak.lastDate === date) return streak.count; // already counted today
  // if yesterday, streak+1 else reset
  const last = new Date(streak.lastDate + "T00:00:00");
  const today = new Date(date + "T00:00:00");
  const diffDays = Math.round((today - last) / (1000*60*60*24));
  return (diffDays === 1) ? (streak.count + 1) : 1;
}

function saveWorkout(){
  const label = (document.getElementById("labelInput")?.value || "").trim();
  const date = todayStr();
  const elapsedMs = parseTimeChipToMs(chipTime.textContent);

  const q = computeQuality();
  const session = {
    id: cryptoRandom(),
    date,
    label,
    reps,
    elapsedMs,
    quality: q,
    minElbow: Math.round(minElbow),
    avgRepMs: repTimes.length ? Math.round(average(repTimes)) : null,
    createdAt: Date.now()
  };

  // history
  const hist = loadJSON(STORE_KEY, []);
  hist.unshift(session);
  saveJSON(STORE_KEY, hist.slice(0, 100)); // keep last 100

  // PB
  const pb = loadJSON(PB_KEY, { reps: 0, quality: 0 });
  if(session.reps > (pb.reps ?? 0)) pb.reps = session.reps;
  if(session.quality.total > (pb.quality ?? 0)) pb.quality = session.quality.total;
  saveJSON(PB_KEY, pb);

  // streak
  const st = loadJSON(STREAK_KEY, { lastDate: null, count: 0 });
  const preview = computeStreakPreview(date);
  st.lastDate = date;
  st.count = preview;
  saveJSON(STREAK_KEY, st);

  refreshDashboard();
  closeModal();

  btnShareLast.disabled = false;
  btnChallenge.disabled = false;

  setBadge("Saved • open Stats for history");
}

function parseTimeChipToMs(s){
  // "MM:SS"
  const parts = s.split(":").map(x => parseInt(x,10));
  if(parts.length !== 2 || parts.some(isNaN)) return 0;
  return (parts[0]*60 + parts[1]) * 1000;
}

function cryptoRandom(){
  // simple unique-ish id
  return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
}

function refreshDashboard(){
  const hist = loadJSON(STORE_KEY, []);
  const pb = loadJSON(PB_KEY, { reps: 0, quality: 0 });
  const st = loadJSON(STREAK_KEY, { lastDate: null, count: 0 });

  dToday.textContent = todayStr();
  dPB.textContent = `${pb.reps ?? 0} reps`;
  dStreak.textContent = `${st.count ?? 0} days`;

  chipStreak.textContent = `Streak: ${st.count ?? 0}d`;

  if(hist.length){
    const last = hist[0];
    dLast.textContent = `${last.reps} reps • Q${last.quality.total} • ${mmss(last.elapsedMs)}`;
    dLastDetail.textContent = `${last.date}${last.label ? " • " + last.label : ""} • min elbow ${last.minElbow}° • avg rep ${last.avgRepMs ? (last.avgRepMs/1000).toFixed(2)+"s" : "—"}`;
    btnShareLast.disabled = false;
    btnChallenge.disabled = false;

    dQuality.textContent = `Quality ${last.quality.total} (Depth ${last.quality.depth}, Tempo ${last.quality.tempo}, Align ${last.quality.align}).`;
  } else {
    dLast.textContent = "—";
    dLastDetail.textContent = "No history yet.";
    btnShareLast.disabled = true;
    btnChallenge.disabled = true;
  }

  // chips
  chipQuality.textContent = "Quality: —";
  chipTime.textContent = "00:00";
}

function openHistory(){
  const hist = loadJSON(STORE_KEY, []);
  modalTitle.textContent = "History (local)";
  if(!hist.length){
    modalBody.innerHTML = `<div class="tiny">No sessions yet. Do a set, hit END, then Save.</div>`;
  } else {
    const rows = hist.slice(0, 20).map(s => {
      const label = s.label ? ` • ${escapeHTML(s.label)}` : "";
      return `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)">
        <div><b>${s.reps}</b> reps • Q${s.quality.total} • ${mmss(s.elapsedMs)}</div>
        <div class="tiny" style="margin-top:4px;color:rgba(255,255,255,.68)">${s.date}${label}</div>
      </div>`;
    }).join("");
    modalBody.innerHTML = rows;
  }

  const btns = document.getElementById("modalBtns");
  btns.innerHTML = `
    <button class="secondary" onclick="closeModal()">Close</button>
    <button onclick="exportJSON()">Export JSON</button>
    <button onclick="clearData()">Reset</button>
  `;

  modalWrap.classList.add("show");
}

function exportJSON(){
  const hist = loadJSON(STORE_KEY, []);
  const blob = new Blob([JSON.stringify(hist, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tracksimpli_history.json";
  a.click();
  URL.revokeObjectURL(url);
}

function clearData(){
  localStorage.removeItem(STORE_KEY);
  localStorage.removeItem(PB_KEY);
  localStorage.removeItem(STREAK_KEY);
  refreshDashboard();
  closeModal();
  setBadge("Local data reset");
}

function escapeHTML(s){
  return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function closeModal(){ modalWrap.classList.remove("show"); }

/* ---------------------------
   Share card + challenge link
---------------------------- */
function getLastSession(){
  const hist = loadJSON(STORE_KEY, []);
  return hist.length ? hist[0] : null;
}

async function shareLast(){
  const last = getLastSession();
  if(!last) return;
  await shareCard(last);
}

function buildChallengeURL(session){
  const url = new URL(window.location.href);
  url.searchParams.set("challenge", "1");
  url.searchParams.set("reps", String(session.reps));
  url.searchParams.set("q", String(session.quality.total));
  url.searchParams.set("t", String(Math.round(session.elapsedMs/1000)));
  url.searchParams.set("d", session.date);
  return url.toString();
}

async function copyChallengeLink(){
  const last = getLastSession();
  if(!last) return;
  const link = buildChallengeURL(last);
  await navigator.clipboard.writeText(link);
  setBadge("Challenge link copied");
}

function showChallengeBannerFromURL(){
  const p = new URLSearchParams(window.location.search);
  if(p.get("challenge") !== "1") return;

  const reps = p.get("reps") || "?";
  const q = p.get("q") || "?";
  const t = p.get("t") || "?";
  const d = p.get("d") || "";
  challengeBanner.style.display = "block";
  challengeBanner.innerHTML = `<b>Challenge:</b> Beat <b>${reps}</b> reps (Q${q}, ${t}s) ${d ? "• " + d : ""}`;
}

async function shareCard(sessionOverride){
  const session = sessionOverride || getLastSession();
  if(!session){
    setBadge("No saved session to share");
    return;
  }

  const cardBlob = await makeShareImage(session);

  const link = buildChallengeURL(session);
  const text = `TrackSimpli Pushups: ${session.reps} reps • Quality ${session.quality.total} • Time ${mmss(session.elapsedMs)}\nChallenge: ${link}`;

  // Try native share
  try{
    if(navigator.share && cardBlob){
      const file = new File([cardBlob], "tracksimpli.png", { type:"image/png" });
      await navigator.share({
        title: "TrackSimpli",
        text,
        files: [file],
        url: link
      });
      setBadge("Shared");
      return;
    }
  }catch{}

  // Fallback: copy link + download image
  try{
    await navigator.clipboard.writeText(link);
    setBadge("Link copied (share unsupported)");
  }catch{
    setBadge("Share unsupported");
  }

  if(cardBlob){
    const url = URL.createObjectURL(cardBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "tracksimpli.png";
    a.click();
    URL.revokeObjectURL(url);
  }
}

async function makeShareImage(session){
  const c = document.getElementById("shareCanvas");
  const w = 1080, h = 1920; // story-ish
  c.width = w; c.height = h;
  const g = c.getContext("2d");

  // background
  g.fillStyle = "#0b0d10";
  g.fillRect(0,0,w,h);

  // subtle gradient
  const grad = g.createLinearGradient(0,0,0,h);
  grad.addColorStop(0, "rgba(42,60,255,.25)");
  grad.addColorStop(1, "rgba(0,0,0,0)");
  g.fillStyle = grad;
  g.fillRect(0,0,w,h);

  // title
  g.fillStyle = "white";
  g.font = "900 70px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText("TrackSimpli", 70, 140);

  g.fillStyle = "rgba(255,255,255,.75)";
  g.font = "600 36px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText("Pushups", 70, 200);

  // big reps
  g.fillStyle = "white";
  g.font = "900 220px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText(String(session.reps), 70, 520);

  g.fillStyle = "rgba(255,255,255,.75)";
  g.font = "800 44px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText("REPS", 70, 590);

  // stats block
  drawStat(g, 70, 720, "Quality", String(session.quality.total));
  drawStat(g, 70, 840, "Time", mmss(session.elapsedMs));
  drawStat(g, 70, 960, "Depth (min elbow)", session.minElbow + "°");
  drawStat(g, 70, 1080, "Avg rep tempo", session.avgRepMs ? (session.avgRepMs/1000).toFixed(2)+"s" : "—");

  // footer
  g.fillStyle = "rgba(255,255,255,.55)";
  g.font = "700 32px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText(session.date + (session.label ? " • " + session.label : ""), 70, 1780);

  g.fillStyle = "rgba(255,255,255,.60)";
  g.font = "700 28px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText("Beat my score → (challenge link)", 70, 1840);

  return await new Promise(resolve => c.toBlob(resolve, "image/png", 0.92));
}

function drawStat(g, x, y, k, v){
  g.fillStyle = "rgba(255,255,255,.55)";
  g.font = "800 36px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText(k.toUpperCase(), x, y);

  g.fillStyle = "white";
  g.font = "900 60px system-ui, -apple-system, Segoe UI, Roboto";
  g.fillText(String(v), x, y+72);

  // divider
  g.fillStyle = "rgba(255,255,255,.10)";
  g.fillRect(x, y+102, 940, 2);
}

/* ---------------------------
   Boot
---------------------------- */
refreshDashboard();
showChallengeBannerFromURL();

// keep time chip updating during workout
requestAnimationFrame(updateTimeChip);

// nicer badge messages
setBadge("Ready • tap START");
</script>
</body>
</html>